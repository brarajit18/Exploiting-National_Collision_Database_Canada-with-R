#set the working directory pointing to the source file location
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
getwd()

# defining a function  to check the installation
is.installed <- function(mypkg) is.element(mypkg, installed.packages()[,1])

#Install libraries
if (is.installed("sqldf") == FALSE) {
  install.packages("sqldf") # Require "sqldf" to exploit dataframe using sql syntax
}
if (is.installed("ggplot2") == FALSE) {
  install.packages("ggplot2") # Require ggplot2 for visualization
}
if (is.installed("dplyr") == FALSE) {
  install.packages("dplyr") # Require for data manipulation
}

# Read the CSV file from source
#df <- read.csv('NCDB_1999_to_2017.csv') #Execution on full dataset
df <- read.csv('NCDB_mini_3pct.csv') # Execute on sample dataset
head(df) #view header of the file


## SAVE THE RESULTS IN FOLLOWING FILE
file.remove("visualization_results.pdf")
pdf(file = "visualization_results.pdf") #Set the output file's output pipleline

####### 1.                                 #######
####### TOTAL COLLISION INCIDENTS RECORDED #######

# Analyze the year-wise collisions (1999-2017)
# Q1: ARE THE COLLISIONS ON THE RISE EVERY YEAR?
sub_df <- df[c('C_YEAR')] # Subset extraction
library(sqldf) # Activate "sqldf" library
report_q1 <- sqldf("SELECT
                      C_YEAR as Year,
                      count(*) as Count_of_Collision
                    FROM sub_df
                    GROUP BY C_YEAR
                    ORDER BY C_YEAR") # Group by and Count by Year

library(ggplot2)
ggplot(data=report_q1, aes(x=Year, y=Count_of_Collision, group=1)) +
  geom_line()+
  geom_point()+
  labs(title="Figure 1: Canada National Collision Data (Year-wise sorted)")


####### 2.                                  #######
####### TOTAL COLLISION FATALITIES RECORDED #######

# Analyze the year-wise fatalities caused by collisions (1999-2017)
# Q2: ARE THE COLLISION FATALITIES ON THE RISE EVERY YEAR?
sub_df <- subset(df, C_SEV == 1, select=c('C_YEAR'))

report_q2 <- sqldf("SELECT
                      C_YEAR as Year,
                      count(*) as Fatalities
                    FROM sub_df
                    GROUP BY C_YEAR
                    ORDER BY C_YEAR")

library(ggplot2)
# Basic line plot with points
ggplot(data=report_q2, aes(x=Year, y=Fatalities, group=1)) +
  geom_line()+
  geom_point()+
  labs(title="Figure 2: On-road Collisions causing Fatalities")


####### 3.                            #######
####### COLLISION ANALYSIS BY WEATHER #######

# Analyze the year-wise fatalities caused by collisions (1999-2017)
# Q3: DOES WEATHER AFFECT THE COLLISIONS?
# Extract a subset from main dataframe
sub_df <- df[c('C_YEAR', 'C_MNTH', 'C_WDAY', 'C_WTHR', 'C_SEV')]
# Apply SQL syntax to exploit the data
report_q3 <- sqldf("SELECT
                      C_WTHR as Weather,
                      count(*) as Accidents_Collisions
                    FROM sub_df
                    GROUP BY C_WTHR
                    ORDER BY C_WTHR")
# Calculate percentage from number of incidents
report_q3$Accidents_Collisions_Ratio = (report_q3$Accidents_Collisions/nrow(sub_df))*100
# Simple Horizontal Bar Plot with Added Labels
# Fitting Labels
opar <- par()      # make a copy of current settings
par(las=2) # make label text perpendicular to axis
par(mar=c(5,8,4,2)) # increase y-axis margin.
# Print the bar graph
barplot(report_q3$Accidents_Collisions_Ratio, main="Figure 3: Accident Ratio", xlab="Percentage", horiz=TRUE,
        names.arg=c("Clean & Sunny", "Cloudy, No Rain", "Rain", "Snow",
                    "Freezing Rain", "Low Visibility", "Strong wind", "Other", "Unknown"))
# Reset the par to defaults
par(opar)


####### 4.                  #######
####### MONTH-WISE ANALYSIS #######

# Q4: WHICH MONTH IS MOST FATAL ON CANADIAN ROADS?
# Apply SQL syntax to exploit the data
report_q4 <- sqldf("SELECT
                      C_MNTH as MONTH,
                      count(*) as Accidents_Collisions
                    FROM sub_df
                    GROUP BY C_MNTH
                    ORDER BY C_MNTH")
# Calculate percentage from number of incidents
report_q4$Accidents_Collisions_Ratio = (report_q4$Accidents_Collisions/nrow(sub_df))*100
# Simple Horizontal Bar Plot with Added Labels
# Fitting Labels
opar <- par()      # make a copy of current settings
par(las=2) # make label text perpendicular to axis
par(mar=c(5,8,4,2)) # increase y-axis margin.
# Print the bar graph
barplot(report_q4$Accidents_Collisions_Ratio, main="Figure 4: MONTH-WISE COLLISION PERCENTAGE",
                    xlab="Percentage", horiz=TRUE,
                    names.arg=c("Jan", "Feb", "Mar", "Apr","May","Jun", "Jul", "Aug",
                    "Sep", "Oct", "Nov", "Dec", "Other"))
# Reset the par to defaults
par(opar)


####### 5.                    #######
####### WEEK DAY WISE ANALYSIS #######
#Q6: WHAT DAY OF WEEK IS MORE DANGEROUS TO DRIVE ON CANADIAN ROADS?
library(dplyr)

by_wday <- df %>% group_by(C_WDAY)
by_wday_groups <- by_wday %>% summarise(n = n())
out <- (by_wday_groups$n/sum(by_wday_groups$n))*100
by_wday_groups$n <- out
weekdays <- c("MON", "TUE", "WED", "THU", "FRI", "SAT", "SUN", "NO DATA")
by_wday_groups$weekdays <- weekdays
by_wday_groups
by_wday_groups <- by_wday_groups[c('weekdays', 'n')]
wday <- by_wday_groups[c('weekdays', 'n')]


# Fitting Labels
opar <- par()      # make a copy of current settings
par(las=2) # make label text perpendicular to axis
par(mar=c(9,8,4,2)) # increase y-axis margin.
# Print the bar graph
barplot(wday$n, main="Figure 5: Day-wise Collision Analysis", xlab="Percentage", horiz=TRUE,
        names.arg=c("MON", "TUE", "WED", "THU", "FRI", "SAT", "SUN", "NO DATA"))
# Reset the par to defaults
par(opar)


####### 6.                 #######
####### HOUR-WISE ANALYSIS #######
library(dplyr)
by_hour <- df %>% group_by(C_HOUR)
by_hour_groups <- by_hour %>% summarise(n = n())
out <- (by_hour_groups$n/sum(by_hour_groups$n))*100
by_hour_groups$n <- out

# Fitting Labels
opar <- par()      # make a copy of current settings
par(las=2) # make label text perpendicular to axis
par(mar=c(2,4,2,1)) # increase y-axis margin.
# Print the bar graph
barplot(by_hour_groups$n, main="Figure 6: Hour-wise Collision Analysis", xlab="Percentage", horiz=TRUE,
        names.arg=c(seq(0,23),'OTHER'))
# Reset the par to defaults
par(opar)


####### 7.                              #######
####### TYPE OF COLLISION WISE ANALYSIS #######

# Q7: WHAT TYPE OF COLLISIONS ARE MORE LIKELY TO HAPPEN?
# Apply SQL syntax to exploit the data
sub_df <- df[c('C_YEAR', 'C_CONF')]
report_q5 <- sqldf("SELECT
                      C_CONF as TypeOfCollision,
                      count(*) as NoOfCollisions
                    FROM sub_df
                    GROUP BY C_CONF
                    ORDER BY C_CONF")

#Singe Vehile in Motion: c(01,02,03,04,05,06)
#Two Vehicles in Motion (Same Direction of Travel): c(21,22,23,24,25)
#Two Vehicles in Motion (Different Direction of Travel) c(31,32,33,34,35,36)
#Two Vehicles (Hit a Parked Motor Vehicle): c(41)
# Other scenarios: c("QQ","UU","XX")

# Define the groups for the different types of collision categories, defined earlier
preGroups <- list(c("01","02","03","04","05","06"), c("21","22","23","24","25"), c("31","32","33","34","35","36"), c("41"), c("QQ","UU","XX"))
# New group mask defined, which will be assinged in connection of "preGroups"
newGroups <- c(1, 2, 3, 4, 5)
# Function to replace the old category type to new category
catManager <- function(x, preGroups, newGroups) {
  i = 1
  for (val in x$TypeOfCollision) {
    j = 1
    for (sublist in preGroups) {
      if (val %in% sublist) {
        x$newtype[i] <- newGroups[j]
      }
      j = j + 1
    }
    i = i + 1
  }
  return (x)
}
# create a new column to observe the new categories
report_q5$newtype <- seq(1,nrow(report_q5))
# show the heading of new data frame
head(report_q5)
# apply the function and dump the output in "x1" data.frame
x1 <- catManager(report_q5, preGroups, newGroups)
# show the data.frame
#x1

# Now regroup the data by new category, where data is compressed to lesser number of categories
new_report_q5 <- sqldf("SELECT
                      newtype as Category,
                      sum(NoOfCollisions) as NumCollisions
                    FROM x1
                    GROUP BY newtype
                    ORDER BY newtype")

#new_report_q5
# Calculate percentage from number of incidents
new_report_q5$NumCollisionRatio = (new_report_q5$NumCollisions/sum(new_report_q5$NumCollisions))*100

# Print the results using a barplot
# Fitting Labels
opar <- par()      # make a copy of current settings
par(las=2) # make label text perpendicular to axis
par(mar=c(9,12,4,2)) # increase y-axis margin.
# Print the bar graph
barplot(new_report_q5$NumCollisionRatio, main="Figure 7: Type Of Collisions", xlab="Percentage", horiz=TRUE,
        names.arg=c("One Veh in Motion", "Two veh, Same Direction",
                    "Two veh, Different Direction", "Two veh, One Parked", "Other"))
# Reset the par to defaults
par(opar)

####### 8.                                #######
####### SINGLE VEHICLE COLLISION ANALYSIS #######
# Single Vehicle in Motion:
# 01	Hit a moving object	E.g. a person or an animal
# 02	Hit a stationary object	E.g. a tree
# 03	Ran off left shoulder	Including rollover in the left ditch
# 04	Ran off right shoulder	Including rollover in the right ditch
# 05	Rollover on roadway
# 06	Any other single vehicle collision configuration

objOfInterest = c("01","02","03","04","05","06") # list of codes marking single vehicle
                                                 # collisions from column C_

sub_df <- df[c('C_YEAR', 'C_CONF')]
report_q8 <- sqldf("SELECT
                      C_CONF as TypeOfCollision,
                      count(*) as NoOfCollisions
                    FROM sub_df
                    WHERE TypeOfCollision in ('01','02','03','04','05','06')
                    GROUP BY C_CONF
                    ORDER BY C_CONF")

# Pie Chart with Percentages
slices <- report_q8['NoOfCollisions'] # Extract the NoOfCollisions column from result data.frame
lbls1 <- c("Hit A Moving Object", "Hit A Stationary Object", "Ran Off Left Shoulder", "Ran Off Right Shoulder", "Rollover on Roadway", "Others") #Mention the labels for categories
data <- data.frame(lbls1, as.vector(100*(slices/sum(slices)))) #
#sapply(data, class)

# Load ggplot2
library(ggplot2)
# Basic piechart
ggplot(data, aes(x="", y=NoOfCollisions, fill=lbls1)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  labs(title="Figure 8: SINGLE VEHICLE COLLISION ANALYSIS")+
  theme_void() # remove background, grid, numeric labels

####### 9.                             #######
####### SAME DIRECTION TRAVEL ANALYSIS #######
# Two Vehicles in Motion - Same Direction of Travel:
# 21	Rear-end collision
# 22	Side swipe
# 23	One vehicle passing to the left of the other, or left turn conflict
# 24	One vehicle passing to the right of the other, or right turn conflict
# 25	Any other two vehicle - same direction of travel configuration


objOfInterest = c("21","22","23","24","25") # list of codes marking single vehicle
# collisions from column C_

sub_df <- df[c('C_YEAR', 'C_CONF')]
report_q9 <- sqldf("SELECT
                      C_CONF as TypeOfCollision,
                      count(*) as NoOfCollisions
                    FROM sub_df
                    WHERE TypeOfCollision in ('21','22','23','24','25')
                    GROUP BY C_CONF
                    ORDER BY C_CONF")

# Pie Chart with Percentages
slices2 <- report_q9['NoOfCollisions'] # Extract the NoOfCollisions column from result data.frame
lbls2 <- c("Rear-end collision","Side swipe","Passing to the left, or left turn conflict","Passing to the right, or right turn conflict","Others") #Mention the labels for categories
data2 <- data.frame(lbls2, as.vector(100*(slices2/sum(slices2)))) #
#sapply(data2, class)

# Load ggplot2
library(ggplot2)
# Basic piechart
ggplot(data2, aes(x="", y=NoOfCollisions, fill=lbls2)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  labs(title="Figure 9: MULTI-VEHICLE COLLISION (SAME DIRECTION)")+
  theme_void() # remove background, grid, numeric labels

####### 10.                                    #######
####### DIFFERENT DIRECTION COLLISION ANALYSIS #######
# Two Vehicles in Motion - Different Direction of Travel:
# 31	Head-on collision
# 32	Approaching side-swipe
# 33	Left turn across opposing traffic
# 34	Right turn, including turning conflicts
# 35	Right angle collision
# 36	Any other two-vehicle - different direction of travel configuration

objOfInterest = c("31","32","33","34","35","36") # list of codes marking single vehicle
# collisions from column C_

sub_df <- df[c('C_YEAR', 'C_CONF')]
report_q10 <- sqldf("SELECT
                      C_CONF as TypeOfCollision,
                      count(*) as NoOfCollisions
                    FROM sub_df
                    WHERE TypeOfCollision in ('31','32','33','34','35','36')
                    GROUP BY C_CONF
                    ORDER BY C_CONF")

# Pie Chart with Percentages
slices3 <- report_q10['NoOfCollisions'] # Extract the NoOfCollisions column from result data.frame
lbls3 <- c("Head-on Collision","Approaching side-swipe","Left turn across opposing traffic","Right turn","Right angle collision","Others") #Mention the labels for categories
data3 <- data.frame(lbls3, as.vector(100*(slices3/sum(slices3)))) #build a dataframe
#sapply(data3, class)

# Load ggplot2
library(ggplot2)
# Basic piechart
ggplot(data3, aes(x="", y=NoOfCollisions, fill=lbls3)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  labs(title="Figure 10: MULTI-VEHICLE COLLISION (DIFFERENT DIRECTION)")+
  theme_void() # remove background, grid, numeric labels


dev.off() #Close PDF file and dump all data into pdf
